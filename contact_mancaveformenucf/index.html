<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" type="image/svg+xml" href="/assets/favicon/tapforgelogofavicon.svg?v=6" />
    <link rel="shortcut icon" href="/assets/favicon/tapforgelogofavicon.svg?v=6" />
    <title>NFC Card</title>
        <link rel="stylesheet" href="../assets/card.css" />
  </head>
  <body>
    <main class="card">
      <img class="card-logo" src="../assets/logo.svg" alt="TapForge logo" />
      <span class="badge">NFC Profile</span>
      <h1 id="name">Loading...</h1>
      <h2 id="business">Loading business...</h2>
      <p class="value" id="hours-inline" hidden style="color: var(--muted); margin: 0.25rem 0 0;"></p>

      <section class="info">
        <div class="row">
          <span class="label">Phone</span>
          <span class="value" id="phone">Loading phone...</span>
        </div>
        <div class="row">
          <span class="label">Address</span>
          <a class="value" id="address" href="#" target="_blank" rel="noopener noreferrer">Loading address...</a>
        </div>
        <div class="row">
          <span class="label">Booking</span>
          <a class="value" id="booking" href="#" target="_blank" rel="noopener noreferrer">Loading booking URL...</a>
        </div>
        <div class="row" id="social-row" hidden>
          <span class="label">Social</span>
          <a class="value" id="social" href="#" target="_blank" rel="noopener noreferrer">Social</a>
        </div>
        <div class="row" id="email-row" hidden>
          <span class="label">Email</span>
          <a class="value" id="email" href="#">Email</a>
        </div>
      </section>

      <section class="actions">
        <a class="btn btn-primary" href="./contact.vcf">Add Contact</a>
        <a class="btn btn-secondary" id="book-btn" href="#">Book Appointment</a>
        <a class="btn btn-secondary" id="call-btn" href="#">Text</a>
      </section>
    </main>

    <script>
      function parseVcf(vcfText) {
        const singleLine = vcfText.replace(/\r?\n[ \t]/g, "").replace(/\r?\n/g, "\n");
        const rawLines = singleLine
          .split(/\n/)
          .map((line) => line.trim())
          .filter(Boolean);

        const lines =
          rawLines.length > 2
            ? rawLines
            : singleLine
                .replace(/^BEGIN:VCARD/i, "")
                .replace(/END:VCARD$/i, "")
                .split(/(?=[A-Z][A-Z0-9-]*(?:;[^:\n]*)?:)/)
                .map((line) => line.trim())
                .filter(Boolean);

        const fields = new Map();
        lines.forEach((line) => {
          const firstColon = line.indexOf(":");
          if (firstColon === -1) return;
          const keyWithParams = line.slice(0, firstColon).trim();
          const value = line.slice(firstColon + 1).trim();
          const baseKey = keyWithParams.split(";")[0].toUpperCase();
          if (!fields.has(baseKey)) fields.set(baseKey, []);
          fields.get(baseKey).push({ keyWithParams, value });
        });

        const getFirst = (key) => (fields.get(key) || []).find((entry) => entry.value)?.value || "";
        const getMatching = (key, matcher) =>
          (fields.get(key) || []).find((entry) => matcher(entry.keyWithParams, entry.value))?.value || "";

        const telEntries = fields.get("TEL") || [];
        const preferredTel =
          telEntries.find((entry) => /(?:^|;)TYPE=([^;]*,)?CELL(?:,|;|$)/i.test(entry.keyWithParams)) ||
          telEntries[0];
        const phone = preferredTel ? preferredTel.value : "";
        const phoneDigits = phone.replace(/\D/g, "");

        const formatPhone = (digits) => {
          if (digits.length === 11 && digits.startsWith("1")) digits = digits.slice(1);
          if (digits.length === 10) {
            return `(${digits.slice(0, 3)}) ${digits.slice(3, 6)}-${digits.slice(6)}`;
          }
          return phone;
        };

        const fullName = getFirst("FN");
        const organization = getFirst("ORG");
        const bookingUrl =
          getMatching("URL", (_key, value) => !/instagram\.com|facebook\.com|x\.com|twitter\.com|tiktok\.com|linkedin\.com|youtube\.com/i.test(value)) || getFirst("URL");
        const addressRaw =
          getMatching("ADR", (key) => /(?:^|;)TYPE=([^;]*,)?WORK(?:,|;|$)/i.test(key)) || getFirst("ADR");
        const adrParts = addressRaw.split(";");
        const address = [adrParts[2], adrParts[3], adrParts[4], adrParts[5], adrParts[6]]
          .filter(Boolean)
          .join(", ");
        const mapsUrl = address
          ? `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(address)}`
          : "";

        const email = getFirst("EMAIL");
        const socialUrl =
          getFirst("X-SOCIALPROFILE") ||
          getMatching("URL",
            (_key, value) => /instagram\.com|facebook\.com|x\.com|twitter\.com|tiktok\.com|linkedin\.com|youtube\.com/i.test(value)
          ) ||
          getFirst("X-SOCIAL") ||
          getFirst("X-INSTAGRAM");

        const noteValue = getFirst("NOTE");
        const hoursFromNote = /(hour|mon|tue|wed|thu|fri|sat|sun|am|pm)/i.test(noteValue) ? noteValue : "";
        const hours = getFirst("X-BUSINESS-HOURS") || getFirst("X-HOURS") || hoursFromNote;

        const normalizedSocialUrl = socialUrl
          ? socialUrl.startsWith("http")
            ? socialUrl
            : `https://${socialUrl.replace(/^@/, "")}`
          : "";

        return {
          fullName,
          organization,
          phone,
          phoneDigits,
          formattedPhone: formatPhone(phoneDigits),
          bookingUrl,
          address,
          mapsUrl,
          email,
          socialUrl: normalizedSocialUrl,
          hours,
        };
      }

      async function hydrateFromVcf() {
        try {
          const response = await fetch("./contact.vcf", { cache: "no-store" });
          if (!response.ok) throw new Error("Unable to load contact.vcf");

          const vcfText = await response.text();
          const profile = parseVcf(vcfText);

          document.getElementById("name").textContent = profile.fullName || "Unknown Name";
          document.getElementById("business").textContent = profile.organization || "Unknown Business";
          document.getElementById("phone").textContent = profile.formattedPhone || profile.phone || "No phone found";

          const addressEl = document.getElementById("address");
          addressEl.textContent = profile.address || "No address found";
          addressEl.href = profile.mapsUrl || "#";

          const bookingEl = document.getElementById("booking");
          bookingEl.textContent = profile.bookingUrl || "No booking URL found";
          bookingEl.href = profile.bookingUrl || "#";

          const socialRow = document.getElementById("social-row");
          const socialEl = document.getElementById("social");
          if (profile.socialUrl) {
            socialRow.hidden = false;
            socialEl.href = profile.socialUrl;
            socialEl.textContent = profile.socialUrl;
          }

          const emailRow = document.getElementById("email-row");
          const emailEl = document.getElementById("email");
          if (profile.email) {
            const mailto = `mailto:${profile.email}`;
            emailRow.hidden = false;
            emailEl.href = mailto;
            emailEl.textContent = profile.email;
          }

          const hoursInline = document.getElementById("hours-inline");
          if (profile.hours) {
            hoursInline.hidden = false;
            hoursInline.textContent = profile.hours;
          }

          document.getElementById("book-btn").href = profile.bookingUrl || "#";
          document.getElementById("call-btn").href = profile.phoneDigits ? `sms:${profile.phoneDigits}` : "#";
          document.title = profile.fullName ? `${profile.fullName} | NFC Card` : "NFC Card";
        } catch (error) {
          document.getElementById("name").textContent = "Could not load profile";
          document.getElementById("business").textContent = "Please verify contact.vcf";
        }
      }

      hydrateFromVcf();
    </script>
  </body>
</html>
